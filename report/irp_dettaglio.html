<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Indice Rischio Ponderato (IRP) - VAROLI GUIDO E FIGLIO S.R.L. | SCAN V16</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/print.css" rel="stylesheet" media="print">
     <style>
        /* Stili V15 mantenuti e aggiustamenti */
        .irp-visual-section { background: linear-gradient(135deg, var(--white) 0%, #f0f4f8 100%); border-radius: 12px; padding: 2rem; box-shadow: var(--shadow); margin-bottom: 2.5rem; border: 1px solid var(--card-border); }
        .irp-main-title { color: var(--primary); font-weight: 700; margin-bottom: 1.5rem; border-bottom: 2px solid var(--secondary); padding-bottom: 0.8rem; }
        .irp-gradient-bar-container { margin-bottom: 0.5rem; }
        .irp-gradient-bar { height: 20px; border-radius: 10px; overflow: hidden; position: relative; background: linear-gradient(to right, #d62246 0%, #d98c00 35%, #ffc107 55%, #4CAF50 80%, #191970 100%); border: 1px solid #bdc3c7; }
        .irp-marker { position: absolute; top: -5px; bottom: -5px; width: 6px; background-color: #ffffff; border: 2px solid #343a40; transform: translateX(-50%); box-shadow: 0 0 8px rgba(0,0,0,0.5); z-index: 2; border-radius: 3px; }
        .irp-marker::after { content: ''; position: absolute; bottom: -7px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 7px solid transparent; border-right: 7px solid transparent; border-top: 8px solid #343a40; }
        .irp-scale-labels { font-size: 0.8rem; color: #6c757d; font-weight: 500; padding: 0 5px;}
        .irp-score-circle { width: 140px; height: 140px; border-radius: 50%; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 0.5rem auto; box-shadow: 0 8px 20px rgba(0,0,0,0.25); background: var(--warning); border: 6px solid rgba(255, 255, 255, 0.5); }
        .irp-score-circle.risk-low { background: radial-gradient(circle, #6bc571, #4CAF50); }
        .irp-score-circle.risk-medium { background: radial-gradient(circle, #ffd54f, #FFC107); }
        .irp-score-circle.risk-high { background: radial-gradient(circle, #f6685e, #F44336); }
        .irp-score-value { font-size: 3.5rem; font-weight: 700; line-height: 1; text-shadow: 1px 1px 3px rgba(0,0,0,0.4);}
        .irp-score-max { font-size: 0.9rem; opacity: 0.8; display: block; line-height: 1;}
        .irp-category-text { font-size: 1.2rem; font-weight: 600; margin-top: 0.5rem; text-align: center; }
        .irp-category-text .status-badge { font-size: 0.85rem; vertical-align: middle; margin-left: 8px;}
        .leanus-scale { position: relative; height: 10px; background: linear-gradient(to right, #d62b22, #FFC107, #4CAF50); border-radius: 5px; margin-top: 5px; margin-bottom: 25px; border: 1px solid #ccc; }
        .leanus-marker { position: absolute; top: -3px; bottom: -3px; width: 4px; background-color: #343a40; border-radius: 2px; transform: translateX(-50%); }
        .leanus-marker-label { position: absolute; top: 12px; transform: translateX(-50%); font-size: 0.85rem; font-weight: bold;}
        .leanus-scale-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #6c757d; }
        .component-card { margin-bottom: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 1px solid var(--card-border);}
        .component-card .card-header { background-color: var(--light); font-weight: 600; border-bottom: 1px solid var(--card-border);}
        .component-card .table { margin-bottom: 0; border: none;}
        .component-card .table th, .component-card .table td { border: none; border-bottom: 1px solid #eee;}
        .component-card .table thead th { border-bottom: 2px solid #ccc;}
        .component-card .table tr:last-child td { border-bottom: none; }
        .component-card .alert-box { margin-top: 1rem; padding: 0.8rem; font-size: 0.85rem;}
        .recommendation-card ol { padding-left: 1.5rem; }
        .recommendation-card li { margin-bottom: 0.8rem; }
        /* Stili per Visualizzazione Z-Score con Punto e Barra SOTTOSTANTE */
        .zscore-scale-container {
            position: relative; /* Contenitore relativo per posizionare punto e label */
            padding-bottom: 30px; /* Spazio per etichette valori e label punto */
            margin-top: 1rem;
            margin-bottom: 1rem; /* Aggiunto margine sotto */
        }
        /* La barra di progresso Bootstrap funge da sfondo colorato */
        .zscore-progress-bar {
            height: 12px;
            border-radius: 6px;
            overflow: hidden; /* Nasconde eccessi barre interne */
            display: flex; /* Necessario per far funzionare le barre interne */
            border: 1px solid #ccc; /* Bordo leggero */
        }
        /* Barre colorate interne */
        .zscore-progress-bar .progress-bar {
             /* Nessun background specifico qui, ereditato da bg-danger etc. */
             /* Nessuna transizione necessaria */
             flex-shrink: 0; /* Non si restringono */
        }
        /* Etichette dei valori soglia (1.81, 2.99) */
        .zscore-threshold-labels {
            position: absolute;
            top: 14px; /* Sotto la barra */
            left: 0;
            right: 0;
            display: flex;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .zscore-threshold-labels .label-181 {
            position: absolute;
            left: 40%; /* Posizione della soglia 1.81 (stimata) */
            transform: translateX(-50%);
        }
        .zscore-threshold-labels .label-299 {
            position: absolute;
            left: 70%; /* Posizione della soglia 2.99 (stimata) */
            transform: translateX(-50%);
        }
        /* Indicatore a punto (sopra la barra) */
        .zscore-indicator-dot {
            position: absolute;
            top: -4px; /* Posiziona il centro del punto leggermente sopra la barra */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transform: translateX(-50%); /* Centra orizzontalmente */
            z-index: 1;
            cursor: default;
        }
        /* Colori dinamici per il punto (come prima) */
        .zscore-indicator-dot.zone-danger { background-color: var(--danger); }
        .zscore-indicator-dot.zone-warning { background-color: var(--warning); }
        .zscore-indicator-dot.zone-success { background-color: var(--success); }

        /* Etichetta valore sotto il punto */
        .zscore-value-label {
            position: absolute;
            top: 22px; /* Sotto il punto */
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.9); /* Sfondo leggermente trasparente */
            padding: 1px 5px;
            border-radius: 3px;
            white-space: nowrap; /* Evita che vada a capo */
            border: 1px solid #ccc;
        }
        /* Altri stili V9/V12 */
         :root {
            --primary: #191970; --secondary: #4a69bd; --success: #4CAF50;
            --warning: #FFC107; --danger: #F44336; --info: #0dcaf0;
            --light: #f8f9fa; --dark: #343a40; --white: #ffffff;
            --text-primary: #212529; --text-secondary: #6c757d;
            --card-bg: var(--white); --card-border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        html, body { height: 100%; overflow-x: hidden; font-family: 'Titillium Web', sans-serif; background-color: #f4f8fb; }
        body { display: flex; }
        .sidebar { width: 250px; background-color: var(--primary); color: #e0e0e0; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1031; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); transition: width 0.3s ease; overflow-y: auto; }
        .main-wrapper { margin-left: 250px; width: calc(100% - 250px); display: flex; flex-direction: column; min-height: 100vh; position: relative; padding-top: 70px; /* Spazio per header */ }
        .dashboard-header { background-color: var(--white); padding: 15px 30px; border-bottom: 1px solid var(--card-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 70px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 250px; right: 0; z-index: 1030; } /* Adjusted left alignment */
        .dashboard-container { padding: 30px; flex-grow: 1; width: 100%; }
        .footer { background-color: var(--primary); color: rgba(255, 255, 255, 0.7); padding: 15px 30px; font-size: 0.85rem; margin-top: auto; flex-shrink: 0; width: 100%; }
        .footer img { max-height: 20px; width: auto; filter: brightness(0) invert(1); opacity: 0.8; vertical-align: middle;}
        .sidebar-header { padding: 10px 20px; margin-bottom: 20px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header img { max-height: 40px; } .sidebar-header h5 { color: var(--white); margin-top: 10px; font-size: 1.1rem; font-weight: 600; }
        .sidebar-nav { list-style: none; padding: 0; } .sidebar-nav .nav-item { margin: 0; }
        .sidebar-nav .nav-link { color: #e0e0e0; padding: 12px 20px; display: flex; align-items: center; font-size: 0.95rem; font-weight: 500; border-left: 4px solid transparent; transition: all 0.2s ease; }
        .sidebar-nav .nav-link:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--white); border-left-color: var(--warning); }
        .sidebar-nav .nav-link.active { background-color: rgba(255, 255, 255, 0.1); color: var(--white); font-weight: 600; border-left-color: var(--white); }
        .sidebar-nav .nav-link i { margin-right: 15px; width: 20px; text-align: center; font-size: 1rem; }
        .sidebar-nav .nav-title { padding: 10px 20px; font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; }
        .sidebar-footer { margin-top: auto; padding: 15px 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.9rem; text-align: left; }
        .section-title { color: var(--primary); font-weight: 600; margin-top: 2.5rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--secondary); font-size: 1.75rem; display: flex; align-items: center; } .section-title i { margin-right: 10px; }
        .dashboard-card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); transition: all 0.3s ease; height: 100%; }
        .dashboard-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); transform: translateY(-3px); }
        .card-title-small { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .table { border: 1px solid var(--card-border); margin-bottom: 1rem; } .table thead th { background-color: var(--light); color: var(--primary); font-weight: 600; border-bottom: 2px solid var(--primary); font-size: 0.9rem; white-space: nowrap; } .table-hover tbody tr:hover { background-color: #eef2f7; } .table td, .table th { vertical-align: middle; padding: 0.6rem 0.75rem; font-size: 0.9rem;} .value-highlight { font-weight: 600; color: var(--primary); } .text-end { text-align: right !important;} .text-success { color: var(--success) !important; } .text-danger { color: var(--danger) !important; } .text-warning { color: var(--warning) !important; } .text-secondary { color: var(--text-secondary) !important; }
         .alert-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid; } .alert-box h5 { margin-bottom: 10px; font-size: 1.1rem; font-weight: 600;} .alert-box ul { padding-left: 20px; margin-bottom: 0; font-size: 0.9rem;} .alert-box.alert-success { background-color: #d1e7dd; border-color: #a3cfbb; color: #0a3622; } .alert-box.alert-warning { background-color: #fff3cd; border-color: #ffda6a; color: #664d03; } .alert-box.alert-danger { background-color: #f8d7da; border-color: #f1aeb5; color: #58151c; } .alert-box.alert-info { background-color: #cff4fc; border-color: #9eeaf9; color: #055160; }
         .status-badge { font-size: .75em; font-weight: 700; line-height: 1; padding: .35em .65em; border-radius: .375rem; color: white; display: inline-block; } .status-badge.bg-success { background-color: var(--success) !important; } .status-badge.bg-warning { background-color: var(--warning) !important; color: var(--dark) !important;} .status-badge.bg-danger { background-color: var(--danger) !important; } .status-badge.bg-info { background-color: var(--info) !important; color: var(--dark) !important;}
         .chart-container { height: 300px; margin-bottom: 20px; background-color: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--card-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
         .icon-circle { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; color: white; margin-right: 12px; font-size: 0.9rem; flex-shrink: 0; }
         .bg-icon-success { background-color: var(--success); } .bg-icon-warning { background-color: var(--warning); } .bg-icon-danger { background-color: var(--danger); } .bg-icon-info { background-color: #4f6d7a; } .bg-icon-primary { background-color: var(--primary); } .bg-icon-secondary { background-color: var(--secondary); }
         @media (max-width: 991.98px) { .sidebar { width: 0; border: none; box-shadow: none;} .main-wrapper { margin-left: 0; width: 100%; padding-top: 56px; } .dashboard-header { left: 0; width: 100%; min-height: 56px; padding: 5px 15px;} .header-title h5 { font-size: 1rem;} .header-title p { font-size: 0.75rem;} .dashboard-container { padding: 15px;} .footer { padding: 10px 15px;} }
         /* Stampa */
          @media print { body { display: block; } .main-wrapper { margin-left: 0; width: 100%; padding-top: 0; } .no-print { display: none !important; } .report-section { page-break-inside: avoid; } /* Altri stili print.css */ }
     </style>
</head>
<body>

<!-- Sidebar -->
    <aside class="sidebar no-print">
        <div class="sidebar-header"> <img src="../assets/img/logo_scan.png" alt="SCAN Logo" style="max-height: 40px;"> <h5>VAROLI GUIDO E FIGLIO S.R.L.</h5> </div>
        <ul class="sidebar-nav flex-grow-1">
            <li class="nav-item"> <a class="nav-link" href="../dashboard_v2.html"> <i class="fas fa-tachometer-alt fa-fw"></i> Dashboard </a> </li>
            <li class="nav-title">Analisi Dettagliata</li>
            <li class="nav-item"> <a class="nav-link" href="parte1_sintesi.html"> <i class="fas fa-file-alt fa-fw"></i> Sintesi e Profilo </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte2_economico.html"> <i class="fas fa-balance-scale fa-fw"></i> Analisi Economica </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte3_patrimoniale.html"> <i class="fas fa-landmark fa-fw"></i> Analisi Patrimoniale </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte4_bancabilita.html"> <i class="fas fa-university fa-fw"></i> Bancabilità </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte5_circolante-flussi.html"> <i class="fas fa-sync-alt fa-fw"></i> Circolante e Flussi </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte6_rischi-raccomandazioni.html"> <i class="fas fa-exclamation-triangle fa-fw"></i> Rischi e Azioni </a> </li>
            <li class="nav-title">Approfondimenti</li>
            <li class="nav-item"> <a class="nav-link active" href="irp_dettaglio.html"> <i class="fas fa-shield-alt fa-fw"></i> Dettaglio IRP </a> </li>
        </ul>
        <div class="sidebar-footer"> <small>SCAN360 © <span id="currentYearSidebar"></span> Kitzanos</small> </div>
    </aside>


    <!-- Contenuto Principale Wrapper -->
    <div class="main-wrapper">
        <!-- Header Orizzontale -->
        <header class="dashboard-header no-print">
            <div class="header-title">
                <h5 class="mb-0">Report Dettagliato: Analisi IRP</h5>
                <p class="mb-0">VAROLI GUIDO E FIGLIO S.R.L. | <span class="report-date">12 Novembre 2025</span></p>
            </div>
            <div class="header-controls d-flex align-items-center">
                <span id="irp-header-badge" class="badge me-3"></span> <!-- Badge will be updated by JS -->
                <button class="btn btn-sm btn-outline-secondary me-2 print-button" onclick="printDocument()"> <i class="fas fa-print"></i> Stampa </button>
                <div class="dropdown">
                    <button class="btn btn-sm btn-light border dropdown-toggle" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false"> <i class="fas fa-user-circle me-1"></i> VAROLI GUIDO E FIGLIO S.R.L. </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuButton"> <li><button class="dropdown-item" type="button" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</button></li> </ul>
                </div>
            </div>
        </header>
        <div class="container d-none d-print-block mt-4 mb-4">
            <h1 class="text-center mb-0"><span class="company-name">VAROLI GUIDO E FIGLIO S.R.L.</span></h1>
            <p class="text-center mb-0">Report Dettagliato: Analisi IRP | <span class="report-date">12 Novembre 2025</span></p>
            <hr>
        </div>

        <!-- Area Contenuto Specifico del Report -->
        <div class="dashboard-container">

            <!-- ================================================================ -->
            <!-- CONTENUTO SPECIFICO IRP DETTAGLIO - V16 - Updated for VAROLI GUIDO E FIGLIO S.R.L. -->
            <!-- ================================================================ -->

             <h2 class="section-title" id="irp-detail"><i class="fas fa-shield-alt me-2"></i>Indice di Rischio Ponderato (IRP) - Dettaglio</h2>

             <!-- Sezione Visuale IRP -->
             <section class="irp-visual-section risk-high report-section" id="irp-summary-section">
                 <h4 class="irp-main-title text-center">Valutazione Complessiva del Rischio</h4>
                 <div class="row align-items-center">
                      <div class="col-lg-5 order-lg-1">
                          <h6 class="text-center text-md-start">Posizionamento sulla Scala di Rischio</h6>
                         <div class="irp-gradient-bar-container">
                             <div class="irp-gradient-bar"> <div class="irp-marker" style="left: 51.42%;" title="IRP: 51.42"></div> </div>
                             <div class="d-flex justify-content-between irp-scale-labels mt-1"> <span>0 (Alto)</span><span>50</span><span>75</span><span>100 (Basso)</span> </div>
                         </div>
                          <p class="small text-muted mt-3">L'IRP Kitzanos (scala 0-100) offre una valutazione olistica dell'affidabilità.</p>
                      </div>
                      <div class="col-lg-7 order-lg-2 mb-4 mb-lg-0 text-center">
                          <div class="irp-score-circle risk-high"> <span class="irp-score-value">51,42</span> <span class="irp-score-max">/ 100</span> </div>
                          <div class="irp-category-text text-danger mt-2"> Rischio elevato <span class="status-badge bg-danger">D+</span> </div>
                      </div>
                 </div>
             </section>

            <!-- Sintesi Calcolo -->
            <div class="card mb-4 report-section">
                 <div class="card-header"><h5 class="mb-0">Sintesi Calcolo IRP</h5></div>
                 <div class="card-body">
                     <p class="small">L'IRP integra quattro distinti modelli di valutazione del rischio.</p>
                     <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover" id="table-irp-sintesi">
                            <thead class="table-light"><tr><th>Componente</th><th class="text-end">Valore Originale</th><th class="text-end">Punteggio Normalizzato</th><th>Peso</th><th class="text-end">Punteggio Ponderato</th></tr></thead>
                            <tbody>
                                <!-- Populated dynamically from tables.json -->
                            </tbody>
                        </table>
                    </div>
                 </div>
             </div>

            <!-- Dettaglio Componenti -->
             <h3 class="section-title mt-5" id="component-details"><i class="fas fa-puzzle-piece me-2"></i>Dettaglio Componenti IRP</h3>
             <div class="row">
                  <!-- CP -->
                 <div class="col-lg-7 report-section">
                     <div class="card component-card h-100">
                         <div class="card-header"><h5 class="mb-0">1. Coefficiente di Ponderazione (CP): <span class="fw-bold text-danger">43,00</span> <span class="status-badge bg-danger float-end">Rischio Elevato</span></h5></div>
                         <div class="card-body">
                             <p class="small">Media ponderata di 6 indicatori finanziari chiave.</p>
                              <div class="table-responsive">
                                  <table class="table table-sm table-hover small mb-0" id="table-irp-cp-detail">
                                     <thead class="table-light"><tr><th>Indicatore</th><th class="text-end">Valore</th><th class="text-end">Punteggio</th><th>Peso</th><th class="text-end">Ponderato</th></tr></thead>
                                     <tbody>
                                         <!-- Populated dynamically from tables.json -->
                                     </tbody>
                                  </table>
                              </div>
                         </div>
                     </div>
                 </div>
                  <!-- Leanus -->
                  <div class="col-lg-5 report-section">
                      <div class="card component-card h-100">
                         <div class="card-header"><h5 class="mb-0">2. Leanus Score Norm.: <span class="fw-bold text-warning">54,70</span> <span class="status-badge bg-warning float-end text-dark">Rischio Moderato</span></h5></div>
                          <div class="card-body">
                               <p class="small mb-1">Score Originale: <strong>-</strong></p>
                               <label class="small fw-bold">Posizionamento Scala Leanus (-40/+40)</label>
                               <div class="leanus-scale mb-1"><div class="leanus-marker" style="left: calc(50% + (-5.3 / 80 * 100%));"></div><div class="leanus-marker-label" style="left: calc(50% + (-5.3 / 80 * 100%));">-5.3</div></div>
                               <div class="leanus-scale-labels"><span>-40</span><span>0</span><span>+40</span></div>
                               <p class="small mt-3 mb-1">Normalizzazione 0-100: 54,70.</p>
                               <div class="alert alert-warning small p-2 mt-2 mb-0"><i class="fas fa-exclamation-triangle me-1"></i>Il Leanus Score e l'MCC Rating confermano un'elevata probabilità di default, sebbene lo Z-Score di Altman indichi una certa resilienza, probabilmente grazie ad alcuni asset. Ciò denota una situazione caratterizzata da particolarità strutturali e dipendenze dai cicli economici naturali rispetto all'operatività ordinaria del settore.</div>
                          </div>
                     </div>
                 </div>
                  <!-- MCC -->
                  <div class="col-lg-5 report-section">
                      <div class="card component-card h-100">
                          <div class="card-header"><h5 class="mb-0">3. MCC Rating: <span class="fw-bold text-danger">46,20</span> <span class="status-badge bg-danger float-end">Rischio Elevato</span></h5></div>
                           <div class="card-body">
                               <p class="small">PD: <strong>-</strong> | MCC: <strong>-</strong>.</p>
                                <p class="small">Valore normalizzato calcolato: 46,20.</p>
                                <div class="alert alert-danger small p-2 mt-2 mb-0"><i class="fas fa-exclamation-triangle me-1"></i>Il punteggio alto lo score di 0 e la categoria di rischio D+ è altamente probabile se 0.0 < MCC < 30.0. In posizioni critiche relativamente alla redditività finanziaria e performance d'azienda, mano nel settore dovrebbero avere indicatori di redditività positivi, un ciclo del circolante più efficiente e un DSCR superiore a 1.</div>
                           </div>
                      </div>
                 </div>
                 <!-- Z-Score Altman -->
              <div class="col-lg-7 report-section">
                   <div class="card component-card h-100">
                      <div class="card-header"><h5 class="mb-0">4. Z-Score di Altman Norm.: <span class="fw-bold text-success">70,40</span> <span class="status-badge bg-success float-end">Rischio Moderato</span></h5></div>
                       <div class="card-body">
                            <p class="small">Z-Score Originale: <strong>-</strong> (<span class="text-warning">Zona Grigia</span>)</p>
                             <label class="small fw-bold">Posizionamento Z-Score</label>
                             <!-- Visualizzazione Scala con Punto SOPRA Barra Progresso -->
                             <div class="zscore-scale-container">
                                 <!-- Barra Bootstrap come sfondo colorato -->
                                 <div class="progress zscore-progress-bar">
                                     <div class="progress-bar bg-danger" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" title="Alto Rischio (<1.81)"></div>
                                     <div class="progress-bar bg-warning" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" title="Zona Grigia (1.81-2.99)"></div>
                                     <div class="progress-bar bg-success" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" title="Zona Sicura (>2.99)"></div>
                                 </div>
                                 <!-- Etichette soglie sotto la barra -->
                                 <div class="zscore-threshold-labels">
                                      <span class="label-181">1.81</span>
                                      <span class="label-299">2.99</span>
                                 </div>
                                 <!-- Punto Indicatore (Posizione e colore calcolati con JS) -->
                                 <div id="zscore-indicator" class="zscore-indicator-dot zone-warning" style="left: 65%;" title="Z-Score: 2.45">
                                     <!-- L'etichetta ora è figlia del punto per posizionamento relativo -->
                                     <span id="zscore-indicator-label" class="zscore-value-label">2.45</span>
                                 </div>
                             </div>
                            <p class="small mt-3 mb-1">Normalizzazione (0-100): 70,40.</p>
                             <div class="alert alert-warning small p-2 mt-2 mb-0"><i class="fas fa-exclamation-triangle me-1"></i>La marginalità operativa negativa è la criticità più pressante, indicando che l'azienda spende più di quanto guadagna dalle sue attività operative principali. Questo è il fulcro dei problemi di redditività.</div>
                       </div>
                   </div>
              </div>
            </div> <!-- Fine row dettaglio componenti -->

             <div class="card mb-4 report-section recommendation-card">
                 <div class="card-header"><h5 class="mb-0">Valutazione Finale e Raccomandazioni Basate sull'IRP</h5></div>
                 <div class="card-body">
                      <h6>Interpretazione IRP (51,42 - Rischio Elevato)</h6>
                      <p class="small">L'Indice di Rischio Ponderato (IRP) di 51,42/100 colloca VAROLI GUIDO E FIGLIO S.R.L. nella fascia di rischio ELEVATO (categoria D+), evidenziando la presenza di significative vulnerabilità finanziarie che richiedono un'attenta e immediata gestione strategica per evitare un ulteriore deterioramento.</p>
                      <div class="row mt-4">
                          <div class="col-md-6"><div class="alert alert-success small p-2 h-100"><h6><i class="fas fa-check-circle me-1"></i> Punti Forza IRP</h6><ul class="mb-0 ps-3">
                          <li>Copertura attivo fisso buona (1,28)</li>
                          <li>Certa solidità patrimoniale in relazione agli investimenti a lungo termine</li>
                          <li>Z-Score di Altman indica una certa resilienza</li>
                          <li>Solidità strutturale del patrimonio</li>
                          </ul></div></div>
                          <div class="col-md-6"><div class="alert alert-danger small p-2 h-100"><h6><i class="fas fa-exclamation-triangle me-1"></i> Aree Critiche IRP</h6><ul class="mb-0 ps-3">
                          <li>EBITDA/Ricavi negativo (-1,53%)</li>
                          <li>EBIT/Oneri finanziari negativo (-1,38)</li>
                          <li>Ciclo del circolante molto lungo (167 giorni)</li>
                          <li>DSCR insufficiente (0,67)</li>
                          <li>Redditività operativa negativa</li>
                          <li>Elevata probabilità di default</li>
                          </ul></div></div>
                      </div>
                      <h6 class="mt-4">Raccomandazioni Operative</h6>
                      <ol class="small">
                          <li><strong>Migliorare la redditività operativa:</strong> Implementare strategie di riduzione dei costi e ottimizzazione dei processi operativi per invertire l'EBITDA negativo. Target: EBITDA/Ricavi positivo entro 6-12 mesi.</li>
                          <li><strong>Ottimizzare il capitale circolante:</strong> Ridurre il ciclo del circolante da 167 a 120 giorni attraverso migliori politiche di gestione delle scorte e riscossione crediti. Impatto stimato: miglioramento significativo della liquidità.</li>
                          <li><strong>Ristrutturare il debito:</strong> Rinegoziare i termini del debito per ridurre gli oneri finanziari e migliorare il DSCR. Target: DSCR > 1 entro 12 mesi.</li>
                          <li><strong>Revisione strategica del business model:</strong> Valutare la redditività delle diverse linee di business e considerare la dismissione di attività non profittevoli.</li>
                      </ol>
                      <h6 class="mt-3">Target di miglioramento</h6>
                      <div class="table-responsive">
                          <table class="table table-sm table-striped" id="table-irp-target">
                              <thead class="table-light">
                                  <tr>
                                      <th>Orizzonte temporale</th>
                                      <th class="text-center">Target IRP</th>
                                      <th class="text-center">Categoria target</th>
                                      <th>Azioni chiave</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <!-- Populated dynamically from tables.json -->
                              </tbody>
                          </table>
                      </div>
                 </div>
            </div>

            <!-- ================================================================ -->
            <!-- FINE CONTENUTO SPECIFICO IRP DETTAGLIO -->
            <!-- ================================================================ -->

       </div> <!-- /dashboard-container -->

        <!-- Footer Standard V2 (Nessuna modifica necessaria) -->
        <footer class="footer no-print"> <div class="container-fluid px-4"> <div class="row align-items-center"> <div class="col-md-6 text-center text-md-start mb-2 mb-md-0"> SCAN360 © <span id="currentYearFooterReport"></span> </div> <div class="col-md-6 text-center text-md-end"> Powered by <a href="http://www.kitzanos.com" target="_blank" class="text-white fw-bold">Kitzanos Lab</a> <img src="../assets/img/logo_kitzanos.png" alt="Kitzanos Logo" class="ms-2"> </div> </div> </div> </footer>

    </div> <!-- /main-wrapper -->

    <!-- Script JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="../js/data-manager.js"></script>

    <script>
        document.getElementById('currentYearSidebar').textContent = new Date().getFullYear();
        document.getElementById('currentYearFooterReport').textContent = new Date().getFullYear();

        window.logout = function() { window.location.href = "../index.html"; };
        window.printDocument = function() { window.print(); };

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await window.dataManager.loadAll();

                // Populate company name
                const companyName = window.dataManager.getCompanyName();
                if (companyName) {
                    document.querySelectorAll('.company-name, .sidebar-header h5, button[id="userMenuButton"]').forEach(el => {
                        if (el.tagName === 'BUTTON') {
                            el.innerHTML = `<i class="fas fa-user-circle me-1"></i> ${companyName}`;
                        } else {
                            el.textContent = companyName;
                        }
                    });
                }

                // Update IRP badge and visual elements
                const irpKPI = window.dataManager.getKPI('irp');
                if (irpKPI) {
                    const irpScoreValue = parseFloat(irpKPI.value);

                    // Update header badge
                    const irpHeaderBadge = document.getElementById('irp-header-badge');
                    if (irpHeaderBadge) {
                        const badgeClass = irpKPI.status === 'danger' ? 'bg-danger' :
                                         irpKPI.status === 'warning' ? 'bg-warning text-dark' : 'bg-success';
                        irpHeaderBadge.className = `badge ${badgeClass} me-3`;
                        irpHeaderBadge.textContent = `IRP: ${irpKPI.displayValue}`;
                    }

                    // Update IRP section visual elements
                    const irpSection = document.getElementById('irp-summary-section');
                    const scoreCircle = document.querySelector('.irp-score-circle');
                    const categoryTextElement = document.querySelector('.irp-category-text');
                    const categoryBadge = categoryTextElement ? categoryTextElement.querySelector('.status-badge') : null;

                    let sectionBorderClass = irpKPI.status === 'danger' ? 'risk-high' :
                                           irpKPI.status === 'warning' ? 'risk-medium' : 'risk-low';
                    let circleClass = sectionBorderClass;
                    let categoryText = irpKPI.status === 'danger' ? 'elevato' :
                                      irpKPI.status === 'warning' ? 'medio' : 'basso';
                    let categoryTextColor = irpKPI.status === 'danger' ? 'text-danger' :
                                          irpKPI.status === 'warning' ? 'text-warning' : 'text-success';
                    let badgeClass = irpKPI.status === 'danger' ? 'bg-danger' :
                                    irpKPI.status === 'warning' ? 'bg-warning' : 'bg-success';

                    if (irpSection) {
                        irpSection.classList.remove('risk-low', 'risk-medium', 'risk-high');
                        irpSection.classList.add(sectionBorderClass);
                    }
                    if (scoreCircle) {
                        scoreCircle.classList.remove('risk-low', 'risk-medium', 'risk-high');
                        scoreCircle.classList.add(circleClass);
                    }
                    if (categoryTextElement && categoryBadge) {
                        categoryTextElement.classList.remove('text-success', 'text-warning', 'text-danger');
                        categoryTextElement.textContent = `Rischio ${categoryText} `;
                        categoryTextElement.classList.add(categoryTextColor);
                        categoryBadge.className = `status-badge ${badgeClass}`;
                        categoryBadge.textContent = irpKPI.category || 'D+';
                        if (irpKPI.status === 'warning') categoryBadge.classList.add('text-dark');
                        categoryTextElement.appendChild(categoryBadge);
                    }

                    // Update IRP score display
                    const irpScoreValueEl = document.querySelector('.irp-score-value');
                    if (irpScoreValueEl) {
                        irpScoreValueEl.textContent = irpScoreValue.toFixed(2);
                    }

                    // Update IRP marker position
                    const irpMarker = document.querySelector('.irp-marker');
                    if (irpMarker) {
                        irpMarker.style.left = `${irpScoreValue}%`;
                        irpMarker.title = `IRP: ${irpScoreValue.toFixed(2)}`;
                    }
                }

                // Update Z-Score indicator
                const zScoreKPI = window.dataManager.getKPI('zScore');
                if (zScoreKPI) {
                    const zScoreValue = parseFloat(zScoreKPI.value);
                    const indicatorDot = document.getElementById('zscore-indicator');
                    const indicatorLabel = document.getElementById('zscore-indicator-label');

                    if (indicatorDot && indicatorLabel) {
                        const lowRiskThreshold = 1.81;
                        const safeZoneThreshold = 2.99;
                        const scaleMin = 0;
                        const scaleMax = 8;

                        let positionPercent = ((zScoreValue - scaleMin) / (scaleMax - scaleMin)) * 100;
                        positionPercent = Math.max(0, Math.min(100, positionPercent));

                        indicatorDot.style.left = `${positionPercent}%`;
                        indicatorLabel.textContent = zScoreValue.toFixed(2);

                        indicatorDot.classList.remove('zone-danger', 'zone-warning', 'zone-success');
                        if (zScoreValue < lowRiskThreshold) {
                            indicatorDot.classList.add('zone-danger');
                        } else if (zScoreValue < safeZoneThreshold) {
                            indicatorDot.classList.add('zone-warning');
                        } else {
                            indicatorDot.classList.add('zone-success');
                        }
                    }
                }

                populateIRPTables();
                console.log('✅ Report IRP Dettaglio inizializzato');
            } catch (error) {
                console.error('❌ Errore inizializzazione Report IRP Dettaglio:', error);
            }
        });

        // Helper functions
        function formatNumber(num) {
            return num ? num.toLocaleString('it-IT') : 'N/D';
        }

        function formatPercentage(num) {
            if (num === null || num === undefined) return 'N/D';
            if (typeof num === 'string' && num.includes('%')) return num;
            return num.toFixed(2) + '%';
        }

        function getScoreClass(score) {
            if (score >= 80) return 'text-success';
            if (score >= 50) return 'text-warning';
            return 'text-danger';
        }

        function getComponentIcon(componente) {
            if (!componente) return '';
            const lower = componente.toLowerCase();
            if (lower.includes('coefficiente') || lower.includes('cp')) {
                return '<i class="fas fa-cogs text-primary me-2"></i>';
            } else if (lower.includes('leanus')) {
                return '<i class="fas fa-chart-bar text-success me-2"></i>';
            } else if (lower.includes('mcc')) {
                return '<i class="fas fa-university text-success me-2"></i>';
            } else if (lower.includes('z-score') || lower.includes('altman')) {
                return '<i class="fas fa-calculator text-success me-2"></i>';
            } else if (lower.includes('irp') || lower.includes('indice')) {
                return '<i class="fas fa-shield-alt me-2"></i>';
            }
            return '';
        }

        function populateIRPTables() {
            // Table 1: IRP Components Summary
            const irpComponentsData = window.dataManager.getTable('irp_dettaglio', 'irpComponents');
            if (irpComponentsData && irpComponentsData.rows) {
                const tbody = document.querySelector('#table-irp-sintesi tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    irpComponentsData.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        const isTotal = row.componente && (row.componente.toLowerCase().includes('irp finale') || row.componente.toLowerCase().includes('indice'));

                        if (isTotal) {
                            tr.classList.add('table-primary', 'fw-bold');
                        }

                        const scoreClass = row.scoreClass || (row.punteggioNorm ? getScoreClass(row.punteggioNorm) : '');
                        const icon = getComponentIcon(row.componente);

                        tr.innerHTML = `
                            <td>${icon}${row.componente || ''}</td>
                            <td class="text-end">${row.valoreOriginale || '-'}</td>
                            <td class="text-end score-cell ${scoreClass}">${row.punteggioNorm ? row.punteggioNorm.toFixed(2) : '-'}</td>
                            <td>${row.peso}%</td>
                            <td class="text-end ${isTotal ? 'fs-5' : 'weighted-score-cell'}">${row.ponderato ? row.ponderato.toFixed(2) : ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }

            // Table 2: Coefficiente di Ponderazione Detail
            const cpDetailData = window.dataManager.getTable('irp_dettaglio', 'coefficientePonderazione');
            if (cpDetailData && cpDetailData.rows) {
                const tbody = document.querySelector('#table-irp-cp-detail tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    cpDetailData.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        const scoreClass = row.scoreClass || (row.punteggio ? getScoreClass(row.punteggio) : '');

                        tr.innerHTML = `
                            <td><small>${row.indicatore || ''}</small></td>
                            <td class="text-end">${typeof row.valore === 'number' ? row.valore.toFixed(2) : row.valore}</td>
                            <td class="text-end ${scoreClass}">${row.punteggio ? row.punteggio.toFixed(2) : ''}</td>
                            <td>${row.peso}%</td>
                            <td class="text-end">${row.ponderato ? row.ponderato.toFixed(2) : ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Add total row
                    const totalRow = document.createElement('tr');
                    totalRow.classList.add('border-top', 'fw-bold');
                    totalRow.innerHTML = `
                        <td colspan="4">Punteggio CP Finale</td>
                        <td class="text-end">${cpDetailData.score ? cpDetailData.score.toFixed(2) : '43,00'}</td>
                    `;
                    tbody.appendChild(totalRow);
                }
            }

            // Table 3: Target Improvement
            const targetData = window.dataManager.getTable('irp_dettaglio', 'targetImprovement');
            if (targetData && targetData.rows) {
                const tbody = document.querySelector('#table-irp-target tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    targetData.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.orizzonte || ''}</td>
                            <td class="text-center">${row.targetIRP || ''}</td>
                            <td class="text-center">${row.categoria || ''}</td>
                            <td>${row.azioni || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
        }
    </script>
    <scan-chat data-bot-id="a944ec72-81f6-4a0a-84da-a8ced9377979"></scan-chat>
    <script src="../js/bundle.js"></script>
</body>
</html>