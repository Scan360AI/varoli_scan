<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Patrimoniale - VAROLI GUIDO E FIGLIO S.R.L. | SCAN V9</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/print.css" rel="stylesheet" media="print">
</head>
<body>

<!-- Sidebar -->
    <aside class="sidebar no-print">
        <div class="sidebar-header"> <img src="../assets/img/logo_scan.png" alt="SCAN Logo" style="max-height: 40px;"> <h5>VAROLI GUIDO E FIGLIO S.R.L.</h5> </div>
        <ul class="sidebar-nav flex-grow-1">
            <li class="nav-item"> <a class="nav-link" href="../dashboard_v2.html"> <i class="fas fa-tachometer-alt fa-fw"></i> Dashboard </a> </li>
            <li class="nav-title">Analisi Dettagliata</li>
            <li class="nav-item"> <a class="nav-link" href="parte1_sintesi.html"> <i class="fas fa-file-alt fa-fw"></i> Sintesi e Profilo </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte2_economico.html"> <i class="fas fa-balance-scale fa-fw"></i> Analisi Economica </a> </li>
            <li class="nav-item"> <a class="nav-link active" href="parte3_patrimoniale.html"> <i class="fas fa-landmark fa-fw"></i> Analisi Patrimoniale </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte4_bancabilita.html"> <i class="fas fa-university fa-fw"></i> Bancabilità </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte5_circolante-flussi.html"> <i class="fas fa-sync-alt fa-fw"></i> Circolante e Flussi </a> </li>
            <li class="nav-item"> <a class="nav-link" href="parte6_rischi-raccomandazioni.html"> <i class="fas fa-exclamation-triangle fa-fw"></i> Rischi e Azioni </a> </li>
            <li class="nav-title">Approfondimenti</li>
            <li class="nav-item"> <a class="nav-link" href="irp_dettaglio.html"> <i class="fas fa-shield-alt fa-fw"></i> Dettaglio IRP </a> </li>
        </ul>
        <div class="sidebar-footer"> <small>SCAN360 © <span id="currentYearSidebar"></span> Kitzanos</small> </div>
    </aside>

    <!-- Contenuto Principale Wrapper -->
    <div class="main-wrapper">
        <!-- Header Orizzontale -->
        <header class="dashboard-header no-print">
            <div class="header-title">
                <h5 class="mb-0">Report Dettagliato: Analisi Patrimoniale</h5>
                <p class="mb-0">VAROLI GUIDO E FIGLIO S.R.L. | <span class="report-date">31 Dicembre 2024</span></p>
            </div>
            <div class="header-controls d-flex align-items-center">
                <span id="irp-header-badge" class="badge me-3"></span>
                <button class="btn btn-sm btn-outline-secondary me-2 print-button" onclick="printDocument()"> <i class="fas fa-print"></i> Stampa </button>
                <div class="dropdown">
                    <button class="btn btn-sm btn-light border dropdown-toggle" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false"> <i class="fas fa-user-circle me-1"></i> VAROLI GUIDO E FIGLIO S.R.L. </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuButton"> <li><button class="dropdown-item" type="button" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</button></li> </ul>
                </div>
            </div>
        </header>
        <div class="container d-none d-print-block mt-4 mb-4">
            <h1 class="text-center mb-0"><span class="company-name">VAROLI GUIDO E FIGLIO S.R.L.</span></h1>
            <p class="text-center mb-0">Report Dettagliato: Analisi Patrimoniale | <span class="report-date">31 Dicembre 2024</span></p>
            <hr>
        </div>

        <!-- Area Contenuto Specifico del Report -->
        <div class="dashboard-container">

            <h2 class="section-title" id="patrimonial-analysis"><i class="fas fa-landmark me-2"></i>ANALISI PATRIMONIALE</h2>

         <div class="card mb-4 report-section">
            <div class="card-header"><h5 class="mb-0">1. Stato Patrimoniale Riclassificato (triennio)</h5></div>
            <div class="card-body">
                <p>L'analisi dello Stato Patrimoniale riclassificato secondo il criterio fonti-impieghi evidenzia la seguente situazione per il triennio 2022-2024 di VAROLI GUIDO E FIGLIO S.R.L.</p>

                 <!-- Grafici Composizione Attivo e Passivo -->
                 <div class="row mt-4">
                     <div class="col-lg-6 mb-3 mb-lg-0">
                         <h6 class="text-center small">Grafico 3.1: Composizione Impieghi 2024 (%)</h6>
                         <div class="chart-container" style="height: 300px;">
                             <canvas id="assetsChart"></canvas>
                         </div>
                     </div>
                     <div class="col-lg-6">
                          <h6 class="text-center small">Grafico 3.2: Composizione Fonti 2024 (%)</h6>
                          <div class="chart-container" style="height: 300px;">
                              <canvas id="liabilitiesChart"></canvas>
                          </div>
                     </div>
                 </div>

                 <h6 class="mt-4">Tabella 3.1: Stato Patrimoniale Riclassificato 2022-2024 (valori in €)</h6>
                 <div class="table-responsive">
                     <table class="table table-sm table-striped table-hover" id="table-parte3-stato-patrimoniale">
                         <thead class="table-light">
                             <tr><th>IMPIEGHI</th><th class="text-end">12/2022</th><th class="text-end">%</th><th class="text-end">12/2023</th><th class="text-end">%</th><th class="text-end">12/2024</th><th class="text-end">%</th><th class="text-end">Δ 2023-24</th></tr>
                         </thead>
                         <tbody id="tbody-impieghi">
                             <!-- Populated by JS -->
                         </tbody>
                         <thead class="table-light">
                              <tr><th>FONTI</th><th class="text-end">12/2022</th><th class="text-end">%</th><th class="text-end">12/2023</th><th class="text-end">%</th><th class="text-end">12/2024</th><th class="text-end">%</th><th class="text-end">Δ 2023-24</th></tr>
                         </thead>
                         <tbody id="tbody-fonti">
                             <!-- Populated by JS -->
                         </tbody>
                     </table>
                 </div>
            </div>
        </div>

        <div class="card mb-4 report-section">
             <div class="card-header"><h5 class="mb-0">2. Struttura degli Investimenti</h5></div>
             <div class="card-body">
                <p>L'analisi della struttura degli investimenti evidenzia un'azienda con una significativa incidenza dell'attivo circolante (80,2% nel 2024), in aumento rispetto agli esercizi precedenti. Questo dato è coerente con la natura dell'attività di commercio all'ingrosso di legname e materiali da costruzione, che tipicamente richiede investimenti significativi in scorte di magazzino e capitale circolante.</p>
                 <div class="row">
                    <div class="col-lg-7 mb-3 mb-lg-0">
                         <h6 class="text-center small">Grafico 3.3: Evoluzione Struttura Impieghi (€)</h6>
                         <div class="chart-container" style="height: 350px;">
                             <canvas id="investmentsStructureChart"></canvas>
                         </div>
                    </div>
                     <div class="col-lg-5">
                         <h6 class="mt-1">Analisi Composizione Impieghi 2024:</h6>
                          <ul class="small list-unstyled">
                             <li class="mb-2"><span class="icon-circle icon-circle-sm bg-icon-primary me-2"><i class="fas fa-building"></i></span><strong>Attivo Fisso (€454.485):</strong> 19,8% del Tot. Impieghi. Riduzione -16,2% rispetto al 2023.</li>
                             <li class="mb-2"><span class="icon-circle icon-circle-sm bg-icon-info me-2"><i class="fas fa-laptop"></i></span><strong>Imm. Immateriali (€12.345):</strong> 2,7% dell'Attivo Fisso, principalmente software e licenze.</li>
                             <li class="mb-2"><span class="icon-circle icon-circle-sm bg-icon-warning me-2"><i class="fas fa-tools"></i></span><strong>Imm. Materiali (€442.140):</strong> 97,3% dell'Attivo Fisso, attrezzature e immobili.</li>
                             <li class="mb-2"><span class="icon-circle icon-circle-sm bg-icon-secondary me-2"><i class="fas fa-sync-alt"></i></span><strong>Attivo Circolante (€1.828.448):</strong> 80,2% del Tot. Impieghi. Contrazione -8,4%. <span class="text-danger">Rimanenze elevate (€1.067.842) e Crediti in calo (-23,3%).</span></li>
                          </ul>
                     </div>
                 </div>
             </div>
        </div>

        <div class="card mb-4 report-section">
             <div class="card-header"><h5 class="mb-0">3. Struttura delle Fonti</h5></div>
              <div class="card-body">
                 <p>L'analisi della struttura delle fonti evidenzia un'azienda con un grado di patrimonializzazione in significativo deterioramento. Il Patrimonio Netto rappresenta solo il 17,5% del totale delle fonti nel 2024, in forte diminuzione rispetto agli esercizi precedenti.</p>
                 <div class="row">
                    <div class="col-lg-6 mb-3 mb-lg-0">
                         <h6 class="text-center small">Grafico 3.4: Composizione Patrimonio Netto 2024 (%)</h6>
                         <div class="chart-container" style="height: 300px;">
                             <canvas id="equityCompositionChart"></canvas>
                         </div>
                         <h6 class="mt-3">Analisi Patrimonio Netto (€ 479.666, -26,3%):</h6>
                          <ul class="small list-unstyled">
                             <li><i class="fas fa-arrow-down text-warning me-1"></i> Riduzione dovuta alla perdita d'esercizio (-€149.177).</li>
                             <li><i class="fas fa-exclamation-triangle text-danger me-1"></i> Incidenza su Fonti: <strong>17,5%</strong> <span class="status-badge bg-danger">Insufficiente</span>.</li>
                          </ul>
                    </div>
                     <div class="col-lg-6">
                         <h6 class="text-center small">Grafico 3.5: Composizione Passività Correnti 2024 (%)</h6>
                         <div class="chart-container" style="height: 300px;">
                             <canvas id="currentLiabilitiesChart"></canvas>
                         </div>
                          <h6 class="mt-3">Analisi Passività Correnti (€529.214, -20,2%):</h6>
                           <ul class="small list-unstyled">
                              <li><i class="fas fa-building text-info me-1"></i> Debiti Fornitori: €388.221 (73,4% delle passività correnti).</li>
                              <li><i class="fas fa-file-invoice text-warning me-1"></i> Altri Debiti: €140.993 (26,6%), inclusi debiti tributari e ratei.</li>
                              <li><i class="fas fa-shield-alt text-warning me-1"></i> Fondi TFR: €78.839 (+29,6%).</li>
                              <li><i class="fas fa-exclamation-triangle text-danger me-1"></i> <strong>Elevati debiti finanziari</strong> <span class="status-badge bg-danger">Critico</span>.</li>
                           </ul>
                     </div>
                 </div>
              </div>
        </div>

        <div class="card mb-4 report-section">
             <div class="card-header"><h5 class="mb-0">4. Posizione Finanziaria Netta (PFN)</h5></div>
             <div class="card-body">
                 <p>La Posizione Finanziaria Netta (PFN), calcolata come differenza tra i debiti finanziari e le disponibilità liquide, presenta la seguente evoluzione nel triennio.</p>
                 <div class="row">
                    <div class="col-lg-7 mb-3 mb-lg-0">
                         <h6 class="mt-1">Tabella 4.1: Analisi PFN 2022-2024 (€)</h6>
                         <div class="table-responsive">
                             <table class="table table-sm table-striped table-hover" id="table-parte3-pfn">
                                 <thead>
                                     <tr><th>Componente</th><th class="text-end">12/2022</th><th class="text-end">12/2023</th><th class="text-end">12/2024</th><th class="text-end">Var% 23-24</th></tr>
                                 </thead>
                                 <tbody>
                                     <!-- Populated by JS -->
                                 </tbody>
                             </table>
                         </div>
                    </div>
                     <div class="col-lg-5">
                         <h6 class="text-center small">Grafico 4.1: Evoluzione PFN e Liquidità (€)</h6>
                          <div class="chart-container" style="height: 300px;">
                             <canvas id="pfnTrendChart"></canvas>
                         </div>
                         <h6 class="mt-3">Analisi PFN (VAROLI GUIDO E FIGLIO S.R.L.):</h6>
                         <ul class="small list-unstyled">
                             <li><i class="fas fa-exclamation-triangle text-danger me-1"></i> PFN positiva: <strong>elevato indebitamento</strong> (€919.610).</li>
                             <li><i class="fas fa-exclamation-triangle text-danger me-1"></i> Peggioramento PFN (+24,5%) dovuto all'incremento dei debiti finanziari e riduzione liquidità.</li>
                             <li><i class="fas fa-exclamation-triangle text-danger me-1"></i> PFN/EBITDA non calcolabile per EBITDA negativo.</li>
                              <li><i class="fas fa-exclamation-triangle text-danger me-1"></i> Elevato rischio finanziario (PFN/PN: 1,92).</li>
                         </ul>
                     </div>
                 </div>
             </div>
         </div>

         <div class="card mb-4 report-section">
            <div class="card-header"><h5 class="mb-0">5. Indici di Solidità Patrimoniale</h5></div>
             <div class="card-body">
                 <p>L'analisi degli indici di solidità patrimoniale fornisce ulteriori elementi per valutare l'equilibrio della struttura finanziaria dell'azienda nel medio-lungo termine.</p>
                  <h6 class="mt-4">Tabella 5.1: Principali Indici di Solidità 2022-2024 (VAROLI GUIDO E FIGLIO S.R.L.)</h6>
                  <div class="table-responsive">
                     <table class="table table-sm table-striped table-hover" id="table-parte3-solidita">
                         <thead class="table-light"><tr><th>Indice</th><th class="text-end">2022</th><th class="text-end">2023</th><th class="text-end">2024</th><th>Valutazione 2024</th></tr></thead>
                         <tbody>
                             <!-- Populated by JS -->
                         </tbody>
                     </table>
                 </div>
                 <div class="row mt-3 small">
                     <div class="col-md-6"><i class="fas fa-exclamation-triangle text-danger me-1"></i><strong>Copertura Immob. (0,56):</strong> Immobilizzazioni non adeguatamente finanziate da capitale proprio.</div>
                     <div class="col-md-6"><i class="fas fa-exclamation-triangle text-danger me-1"></i><strong>Autonomia Fin. (17,5%):</strong> Insufficiente patrimonializzazione.</div>
                     <div class="col-md-6"><i class="fas fa-check-circle text-success me-1"></i><strong>Efficienza Investimenti:</strong> Turnover (2,04x) ottimo, ma elevato indebitamento.</div>
                     <div class="col-md-6"><i class="fas fa-exclamation-triangle text-danger me-1"></i><strong>PFN/EBITDA (N/A):</strong> Critica situazione finanziaria.</div>
                 </div>
             </div>
        </div>

        <div class="card summary-card mb-4 report-section">
             <div class="card-body">
                 <h5 class="card-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>6. Conclusioni Analisi Patrimoniale (VAROLI GUIDO E FIGLIO S.R.L.)</h5>
                 <p>L'analisi patrimoniale di VAROLI GUIDO E FIGLIO S.R.L. evidenzia una <strong>struttura significativamente deteriorata</strong>, caratterizzata da una scarsa patrimonializzazione (17,5%) e da un elevato ricorso al capitale di debito.</p>
                 <p>La società presenta una preoccupante posizione finanziaria netta con <strong>debito netto di €919.610</strong>, in peggioramento del 24,5% rispetto al 2023, e un rapporto PFN/PN pari a 1,92.</p>
                 <p><strong>Punti di debolezza principali:</strong> Insufficiente copertura delle immobilizzazioni (0,56), elevato indebitamento finanziario (D/E 2,66), EBITDA negativo che compromette la sostenibilità del debito e <strong>IRP preoccupante (51,42/100)</strong>.</p>
                 <p class="mb-0"><strong>Raccomandazioni:</strong> Ricapitalizzazione urgente, ristrutturazione operativa per ripristinare la marginalità, ottimizzazione della gestione del magazzino (194 giorni di rotazione) e rimodulazione del debito finanziario per migliorarne la sostenibilità.</p>
             </div>
         </div>

        </div> <!-- /dashboard-container -->

        <!-- Footer Standard V2 -->
        <footer class="footer no-print"> 
            <div class="container-fluid px-4"> 
                <div class="row align-items-center"> 
                    <div class="col-md-6 text-center text-md-start mb-2 mb-md-0"> 
                        SCAN360 © <span id="currentYearFooterReport"></span> 
                    </div> 
                    <div class="col-md-6 text-center text-md-end"> 
                        Powered by <a href="http://www.kitzanos.com" target="_blank" class="text-white fw-bold">Kitzanos Lab</a> 
                        <img src="../assets/img/logo_kitzanos.png" alt="Kitzanos Logo" class="ms-2"> 
                    </div> 
                </div> 
            </div> 
        </footer>

    </div> <!-- /main-wrapper -->

    <!-- Script JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="../js/data-manager.js"></script>

    <script>
        document.getElementById('currentYearSidebar').textContent = new Date().getFullYear();
        document.getElementById('currentYearFooterReport').textContent = new Date().getFullYear();

        window.logout = function() { console.log("Logout action triggered"); };
        window.printDocument = function() { window.print(); };

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await window.dataManager.loadAll();

                // Populate company name
                const companyName = window.dataManager.getCompanyName();
                if (companyName) {
                    document.querySelectorAll('.company-name, .sidebar-header h5, button[id="userMenuButton"]').forEach(el => {
                        if (el.tagName === 'BUTTON') {
                            el.innerHTML = `<i class="fas fa-user-circle me-1"></i> ${companyName}`;
                        } else {
                            el.textContent = companyName;
                        }
                    });
                }

                // Update IRP badge
                const irpKPI = window.dataManager.getKPI('irp');
                if (irpKPI) {
                    const irpHeaderBadge = document.getElementById('irp-header-badge');
                    if (irpHeaderBadge) {
                        const badgeClass = irpKPI.status === 'danger' ? 'bg-danger' :
                                         irpKPI.status === 'warning' ? 'bg-warning text-dark' : 'bg-success';
                        irpHeaderBadge.className = `badge ${badgeClass} me-3`;
                        irpHeaderBadge.textContent = `IRP: ${irpKPI.displayValue}`;
                    }
                }

                // Populate tables
                populateParte3Tables();

                renderParte3Charts();
                console.log('✅ Report Parte 3 inizializzato');
            } catch (error) {
                console.error('❌ Errore inizializzazione Report Parte 3:', error);
            }
        });

        // Helper functions for formatting
        function formatNumber(value) {
            if (value === null || value === undefined) return 'n.d.';
            return value.toLocaleString('it-IT');
        }

        function formatPercentage(value) {
            if (value === null || value === undefined) return 'n.d.';
            return value.toFixed(2) + '%';
        }

        function formatDecimal(value, decimals = 2) {
            if (value === null || value === undefined) return 'n.d.';
            return value.toFixed(decimals);
        }

        function getBadgeClass(valutazione) {
            if (!valutazione) return 'bg-secondary';
            const lower = valutazione.toLowerCase();
            if (lower.includes('critico')) return 'bg-danger';
            if (lower.includes('insufficiente')) return 'bg-danger';
            if (lower.includes('ottimo') || lower.includes('buon')) return 'bg-success';
            if (lower.includes('sufficiente')) return 'bg-warning text-dark';
            return 'bg-secondary';
        }

        // Populate Parte 3 Tables
        function populateParte3Tables() {
            // Table 3.1: Stato Patrimoniale - IMPIEGHI
            const impieghiData = window.dataManager.getTable('parte3_patrimoniale', 'statoPatrimonialeImpieghi');
            if (impieghiData && impieghiData.rows) {
                const tbody = document.querySelector('#tbody-impieghi');
                if (tbody) {
                    tbody.innerHTML = '';
                    impieghiData.rows.forEach(row => {
                        const tr = document.createElement('tr');

                        if (row.highlight) {
                            tr.classList.add('table-primary', 'fw-bold');
                        } else if (row.categoria && row.categoria.includes('Totale Attivo Circolante')) {
                            tr.innerHTML = `<td><strong>${row.categoria}</strong></td>`;
                        } else {
                            tr.innerHTML = `<td>${row.categoria}</td>`;
                        }

                        const varClass = row.varClass || (row.var !== null && row.var < 0 ? 'text-danger' : 'text-success');
                        const isBold = row.highlight || (row.categoria && row.categoria.includes('Totale'));

                        if (isBold && !tr.innerHTML) {
                            tr.innerHTML = `<td><strong>${row.categoria}</strong></td>
                                <td class="text-end"><strong>${formatNumber(row['2022'])}</strong></td>
                                <td class="text-end"><strong>${formatPercentage(row.pct2022)}</strong></td>
                                <td class="text-end"><strong>${formatNumber(row['2023'])}</strong></td>
                                <td class="text-end"><strong>${formatPercentage(row.pct2023)}</strong></td>
                                <td class="text-end"><strong>${formatNumber(row['2024'])}</strong></td>
                                <td class="text-end"><strong>${formatPercentage(row.pct2024)}</strong></td>
                                <td class="text-end ${varClass}"><strong>${row.var >= 0 ? '+' : ''}${formatPercentage(row.var)}</strong></td>`;
                        } else if (!tr.innerHTML) {
                            tr.innerHTML += `
                                <td class="text-end">${formatNumber(row['2022'])}</td>
                                <td class="text-end">${formatPercentage(row.pct2022)}</td>
                                <td class="text-end">${formatNumber(row['2023'])}</td>
                                <td class="text-end">${formatPercentage(row.pct2023)}</td>
                                <td class="text-end">${formatNumber(row['2024'])}</td>
                                <td class="text-end">${formatPercentage(row.pct2024)}</td>
                                <td class="text-end ${varClass}">${row.var >= 0 ? '+' : ''}${formatPercentage(row.var)}</td>`;
                        }

                        tbody.appendChild(tr);
                    });
                }
            }

            // Table 3.1: Stato Patrimoniale - FONTI
            const fontiData = window.dataManager.getTable('parte3_patrimoniale', 'statoPatrimonialeFonti');
            if (fontiData && fontiData.rows) {
                const tbody = document.querySelector('#tbody-fonti');
                if (tbody) {
                    tbody.innerHTML = '';
                    fontiData.rows.forEach(row => {
                        const tr = document.createElement('tr');

                        if (row.highlight) {
                            tr.classList.add('table-primary', 'fw-bold');
                        }

                        const varClass = row.varClass || (row.var !== null && row.var < 0 ? 'text-danger' : 'text-success');
                        const isBold = row.highlight || (row.categoria && row.categoria.includes('Passività Correnti'));

                        if (isBold) {
                            tr.innerHTML = `<td><strong>${row.categoria}</strong></td>
                                <td class="text-end"><strong>${formatNumber(row['2022'])}</strong></td>
                                <td class="text-end"><strong>${formatPercentage(row.pct2022)}</strong></td>
                                <td class="text-end"><strong>${formatNumber(row['2023'])}</strong></td>
                                <td class="text-end"><strong>${formatPercentage(row.pct2023)}</strong></td>
                                <td class="text-end"><strong>${formatNumber(row['2024'])}</strong></td>
                                <td class="text-end"><strong>${formatPercentage(row.pct2024)}</strong></td>
                                <td class="text-end ${varClass}"><strong>${row.var >= 0 ? '+' : ''}${formatPercentage(row.var)}</strong></td>`;
                        } else {
                            tr.innerHTML = `<td>${row.categoria}</td>
                                <td class="text-end">${formatNumber(row['2022'])}</td>
                                <td class="text-end">${formatPercentage(row.pct2022)}</td>
                                <td class="text-end">${formatNumber(row['2023'])}</td>
                                <td class="text-end">${formatPercentage(row.pct2023)}</td>
                                <td class="text-end">${formatNumber(row['2024'])}</td>
                                <td class="text-end">${formatPercentage(row.pct2024)}</td>
                                <td class="text-end ${varClass}">${row.var >= 0 ? '+' : ''}${formatPercentage(row.var)}</td>`;
                        }

                        tbody.appendChild(tr);
                    });
                }
            }

            // Table 4.1: PFN
            const pfnData = window.dataManager.getTable('parte3_patrimoniale', 'pfn');
            if (pfnData && pfnData.rows) {
                const tbody = document.querySelector('#table-parte3-pfn tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    let lastWasSeparator = false;

                    pfnData.rows.forEach(row => {
                        // Add separator row if needed
                        if (row.componente === 'EBITDA' && !lastWasSeparator) {
                            const separatorTr = document.createElement('tr');
                            separatorTr.classList.add('border-top');
                            separatorTr.innerHTML = '<td colspan="5"><em>Indicatori correlati:</em></td>';
                            tbody.appendChild(separatorTr);
                            lastWasSeparator = true;
                        }

                        const tr = document.createElement('tr');

                        if (row.highlight) {
                            tr.classList.add('table-danger', 'fw-bold');
                        } else if (row.componente && row.componente.includes('Totale Debiti')) {
                            tr.classList.add('table-secondary');
                        }

                        const varClass = row.varClass || (row.var !== null && row.var < 0 ? 'text-danger' : 'text-success');

                        // Format values based on component type
                        let val2022, val2023, val2024, varVal;
                        if (row.componente && row.componente.includes('/')) {
                            // Ratio values
                            val2022 = row['2022'] !== null ? formatDecimal(row['2022']) : 'N/A';
                            val2023 = row['2023'] !== null ? formatDecimal(row['2023']) : 'N/A';
                            val2024 = row['2024'] !== null ? formatDecimal(row['2024']) : 'N/A';
                            varVal = row.var !== null ? (row.var >= 0 ? '+' : '') + formatPercentage(row.var) : 'N/A';
                        } else {
                            // Currency values
                            val2022 = formatNumber(row['2022']);
                            val2023 = formatNumber(row['2023']);
                            val2024 = formatNumber(row['2024']);
                            varVal = row.var !== null ? (row.var >= 0 ? '+' : '') + formatPercentage(row.var) : 'N/A';
                        }

                        tr.innerHTML = `
                            <td>${row.componente}</td>
                            <td class="text-end">${val2022}</td>
                            <td class="text-end">${val2023}</td>
                            <td class="text-end">${val2024}</td>
                            <td class="text-end ${varClass}">${varVal}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }

            // Table 5.1: Indici Solidità
            const soliditaData = window.dataManager.getTable('parte3_patrimoniale', 'indiciSolidita');
            if (soliditaData && soliditaData.rows) {
                const tbody = document.querySelector('#table-parte3-solidita tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    soliditaData.rows.forEach(row => {
                        const tr = document.createElement('tr');

                        // Format values
                        let val2022, val2023, val2024;
                        if (row.indice && (row.indice.includes('%') || row.indice.includes('Autonomia'))) {
                            val2022 = row['2022'] !== null ? formatPercentage(row['2022']) : 'n.d.';
                            val2023 = row['2023'] !== null ? formatPercentage(row['2023']) : 'n.d.';
                            val2024 = row['2024'] !== null ? formatPercentage(row['2024']) : 'N/A';
                        } else if (row.indice && row.indice.includes('PFN/EBITDA')) {
                            val2022 = row['2022'] !== null ? formatDecimal(row['2022']) : 'n.d.';
                            val2023 = row['2023'] !== null ? formatDecimal(row['2023']) : 'n.d.';
                            val2024 = row['2024'] !== null ? formatDecimal(row['2024']) : 'N/A';
                        } else {
                            val2022 = row['2022'] !== null ? formatDecimal(row['2022']) : 'n.d.';
                            val2023 = row['2023'] !== null ? formatDecimal(row['2023']) : 'n.d.';
                            val2024 = row['2024'] !== null ? formatDecimal(row['2024']) : 'n.d.';
                        }

                        tr.innerHTML = `
                            <td>${row.indice}</td>
                            <td class="text-end">${val2022}</td>
                            <td class="text-end">${val2023}</td>
                            <td class="text-end">${val2024}</td>
                            <td><span class="status-badge ${row.badgeClass || getBadgeClass(row.valutazione)}">${row.valutazione}</span></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
        }

        function renderParte3Charts() {
            const chartsData = window.dataManager.getChartData('reports', 'parte3');
            if (!chartsData) return;

            // Assets Chart
            if (chartsData.assetsChart) {
                const ctx = document.getElementById('assetsChart');
                if (ctx && !Chart.getChart(ctx)) {
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: chartsData.assetsChart.labels,
                            datasets: [{
                                data: chartsData.assetsChart.datasets.values.data,
                                backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#6c757d', '#6f42c1', '#007bff']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            }

            // Liabilities Chart
            if (chartsData.liabilitiesChart) {
                const ctx = document.getElementById('liabilitiesChart');
                if (ctx && !Chart.getChart(ctx)) {
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: chartsData.liabilitiesChart.labels,
                            datasets: [{
                                data: chartsData.liabilitiesChart.datasets.values.data,
                                backgroundColor: ['#28a745', '#dc3545', '#6c757d', '#fd7e14', '#e83e8c']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            }

            // Investments Structure Chart
            if (chartsData.investmentsStructureChart) {
                const ctx = document.getElementById('investmentsStructureChart');
                if (ctx && !Chart.getChart(ctx)) {
                    const data = chartsData.investmentsStructureChart;
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [
                                { label: data.datasets.fixedAssets.label, data: data.datasets.fixedAssets.data, backgroundColor: '#6f42c1' },
                                { label: data.datasets.receivables.label, data: data.datasets.receivables.data, backgroundColor: '#17a2b8' },
                                { label: data.datasets.inventory.label, data: data.datasets.inventory.data, backgroundColor: '#ffc107' },
                                { label: data.datasets.cash.label, data: data.datasets.cash.data, backgroundColor: '#28a745' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
                    });
                }
            }

            // Equity Composition Chart
            if (chartsData.equityCompositionChart) {
                const ctx = document.getElementById('equityCompositionChart');
                if (ctx && !Chart.getChart(ctx)) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: chartsData.equityCompositionChart.labels,
                            datasets: [{
                                data: chartsData.equityCompositionChart.datasets.values.data,
                                backgroundColor: ['#007bff', '#28a745', '#dc3545', '#6c757d']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            }

            // Financial Debt Sources Chart
            if (chartsData.financialDebtSourcesChart) {
                const ctx = document.getElementById('financialDebtSourcesChart');
                const data = chartsData.financialDebtSourcesChart;
                if (ctx && !Chart.getChart(ctx)) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [
                                { label: data.datasets.financialDebt.label, data: data.datasets.financialDebt.data, type: 'bar', backgroundColor: 'rgba(220, 53, 69, 0.8)', yAxisID: 'y' },
                                { label: data.datasets.equity.label, data: data.datasets.equity.data, type: 'bar', backgroundColor: 'rgba(40, 167, 80, 0.8)', yAxisID: 'y' },
                                { label: data.datasets.debtToEquity.label, data: data.datasets.debtToEquity.data, type: 'line', borderColor: 'rgba(25, 25, 112, 1)', yAxisID: 'y1' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { type: 'linear', position: 'left' }, y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } } } }
                    });
                }
            }

            // PFN Trend Chart
            if (chartsData.pfnTrendChart) {
                const ctx = document.getElementById('pfnTrendChart');
                const data = chartsData.pfnTrendChart;
                if (ctx && !Chart.getChart(ctx)) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [
                                { label: data.datasets.totalDebt.label, data: data.datasets.totalDebt.data, type: 'bar', backgroundColor: 'rgba(220, 53, 69, 0.8)' },
                                { label: data.datasets.cash.label, data: data.datasets.cash.data, type: 'bar', backgroundColor: 'rgba(40, 167, 80, 0.8)' },
                                { label: data.datasets.pfn.label, data: data.datasets.pfn.data, type: 'line', borderColor: 'rgba(25, 25, 112, 1)' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }
        }
    </script>
     
    <!-- Script ChatNode -->
    <scan-chat data-bot-id="a944ec72-81f6-4a0a-84da-a8ced9377979"></scan-chat>
    <script src="../js/bundle.js"></script>
</body>
</html>